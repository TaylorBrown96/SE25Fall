<!-- templates/edit_profile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Profile · Weeklies</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="{{ url_for('index') }}"><span class="logo"></span> Weeklies</a>
    <nav>
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('profile') }}">Profile</a>
      <a href="{{ url_for('restaurants') }}">Restaurants</a>
      <a href="{{ url_for('db_view') }}">DB</a>
      <a href="{{ url_for('logout') }}" data-confirm="Log out now?">Logout</a>
    </nav>
  </div>
</header>

<main class="main">
  <div class="container">
    <div class="card max-w-lg">
      <div class="card-head">
        <h2>Edit Profile</h2>
        <a class="btn btn-outline btn-sm" href="{{ url_for('profile') }}">Cancel</a>
      </div>

      <div class="card-body">
        <form method="POST" action="{{ url_for('edit_profile') }}" id="editProfileForm" novalidate>
          <!-- Read-only context -->
          <div class="section" style="margin-bottom:16px;">
            <div class="form-grid">
              <div>
                <label>First name</label>
                <input class="input read-only" type="text" value="{{ user.first_name }}" disabled>
              </div>
              <div>
                <label>Last name</label>
                <input class="input read-only" type="text" value="{{ user.last_name }}" disabled>
              </div>
              <div>
                <label>Email</label>
                <input class="input read-only" type="email" value="{{ user.email }}" disabled>
              </div>
              <div>
                <label>Phone</label>
                <input class="input" name="phone" type="tel" value="{{ user.phone }}" placeholder="(555) 555-5555">
              </div>
            </div>
          </div>

          <!-- Allergies -->
          <div class="section" style="margin-bottom:16px;">
            <h3 class="section-title">Allergies</h3>
            <p class="muted">Select any allergens that apply.</p>
            <div class="allergen-grid" id="allergenGrid">
              {% set allergens = [
                'Peanuts','Tree Nuts','Milk','Eggs','Wheat','Soy',
                'Fish','Shellfish','Sesame','Gluten','Lactose','Sulphites'
              ] %}
              {% set selected_allergies = (user.allergies or '') %}
              {% set selected_set = selected_allergies|lower %}
              {% for a in allergens %}
              {% set checked = ('checked' if (a.lower() in selected_set) else '') %}
              <label class="allergen">
                <input type="checkbox" name="allergies[]" value="{{ a }}" {{ checked }}>
                <span>{{ a }}</span>
              </label>
              {% endfor %}
            </div>
          </div>

          <!-- Preferences -->
          <div class="section" style="margin-bottom:16px;">
            <h3 class="section-title">Preferences</h3>
            <p class="muted">Tap bubbles to select, or add via the box.</p>
            <div class="pref-toolbar">
              <input class="input" id="prefSearch" type="search" placeholder="Search or add a preference… (press Enter)">
              <button class="btn btn-outline" type="button" id="clearPrefsBtn">Clear</button>
            </div>
            <div class="bubbles" id="bubbles" data-existing="{{ (user.preferences or '') | e }}"></div>
          </div>

          <!-- Hidden serialized fields for server -->
          <input type="hidden" name="allergies" id="allergiesField" value="">
          <input type="hidden" name="preferences" id="preferencesField" value="">

          <div class="btn-row">
            <button type="submit" class="btn btn-primary">Save changes</button>
            <a class="btn btn-outline" href="{{ url_for('profile') }}">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="container">© 2025 Weeklies</div>
</footer>

<style>
  /* Header actions */
  .card-head {
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; border-bottom:1px solid var(--border);
  }
  .card-head h2 { margin:0; font-size:20px; font-weight:700; }

  /* Bubbles (same look as register) */
  .pref-toolbar { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
  .bubbles { display:flex; flex-wrap:wrap; gap:12px; }
  .bubble {
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:999px; border:2px solid var(--border);
    background: rgba(0,0,0,0.05); color: var(--text);
    padding: 8px 14px; cursor:pointer; user-select:none;
    transition: transform .15s ease, border-color .15s ease, box-shadow .15s ease;
    opacity: .5;
  }
  .bubble:hover { transform: translateY(-1px); opacity: .7; }
  .bubble.selected { border-color: currentColor; box-shadow: 0 0 6px currentColor; opacity: 1; }

  .section-title { margin: 0 0 6px; font-size: 18px; }
  .muted { color: var(--muted); font-size: 14px; margin: 0 0 12px; }

  .form-grid { display:grid; gap:12px; grid-template-columns: 1fr; }
  @media (min-width: 720px) { .form-grid { grid-template-columns: 1fr 1fr; } }

  .allergen-grid { display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media (min-width: 720px) { .allergen-grid { grid-template-columns: repeat(3, minmax(0,1fr)); } }
  .allergen { display:flex; gap:10px; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background: var(--surface); }

  .btn-row { display:flex; gap:10px; flex-wrap:wrap; }
  .read-only { background: var(--surface); border:1px dashed var(--border); color: var(--muted); }
</style>

<script>
  // --- Serialize allergies to CSV on submit ---
  (function(){
    const form = document.getElementById('editProfileForm');
    form.addEventListener('submit', (e) => {
      const checks = Array.from(form.querySelectorAll('input[name="allergies[]"]:checked')).map(i => i.value);
      document.getElementById('allergiesField').value = checks.join(',');
      // preferencesField is handled by the bubble script
    }, { passive: false });
  })();

  // --- Preferences bubble builder (editable) ---
  (function() {
    const DEFAULT_PREFS = [
      'Vegan','Vegetarian','Keto','Paleo','Halal','Kosher','Low Sodium','High Protein',
      'Dairy-Free','Gluten-Free','Spicy','Mild','Sweet','Savory','Quick Meals','Budget',
      'Organic','Local','Seasonal','Meal Prep','Breakfast','Lunch','Dinner','Snacks',
      'High Fiber','Low Carb','Low Fat','Sugar-Free','Nut-Free','Shellfish-Free','Soy-Free',
      'Comfort Food','Exotic','Street Food','Fine Dining','Fast Food','Slow Cooked','Grilled',
      'Baked','Fried','Raw','Sushi','Salads','Soups','Sandwiches','Wraps','Smoothies',
      'Juicing','Energy Boost','Post-Workout','Pre-Workout','Family Friendly','Kid Friendly',
      'Romantic','Entertaining','Travel Friendly','Picnic','Camping','Holiday Meals',
      'Desserts','Cakes','Cookies','Pastries','Ice Cream','Chocolate','Coffee','Tea',
      'Wine Pairing','Beer Pairing','Cocktails','Non-Alcoholic','Hydration','Low Caffeine'
    ];

    const bubblesEl = document.getElementById('bubbles');
    const searchEl  = document.getElementById('prefSearch');
    const clearBtn  = document.getElementById('clearPrefsBtn');

    // Utility: random pastel-ish HSL
    function randomColor() {
      const h = Math.floor(Math.random()*360);
      const s = 65 + Math.random()*25;   // 65–90
      const l = 55 + Math.random()*15;   // 55–70
      return `hsl(${h} ${s}% ${l}%)`;
    }

    const state = {
      all: new Map(),       // key -> { el, label, color }
      selected: new Set(),  // keys
    };

    function makeKey(label) { return (label||'').toLowerCase().trim(); }

    function createBubble(label) {
      const key = makeKey(label);
      if (!key) return null;
      if (state.all.has(key)) return state.all.get(key).el;
      const color = randomColor();
      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'bubble';
      el.textContent = label;
      el.style.borderColor = color;
      el.style.color = color;    // currentColor for glow
      el.style.fontSize = Math.random() < 0.5 ? '14px' : '16px';

      el.addEventListener('click', () => {
        const k = makeKey(label);
        if (state.selected.has(k)) {
          state.selected.delete(k);
          el.classList.remove('selected');
        } else {
          state.selected.add(k);
          el.classList.add('selected');
        }
        syncHiddenFields();
      });

      state.all.set(key, { el, label, color });
      return el;
    }

    function renderList(list) {
      bubblesEl.innerHTML = '';
      list.slice(0, 24).forEach(label => {
        const node = createBubble(label);
        if (node) bubblesEl.appendChild(node);
      });
      // re-apply selected classes
      for (const key of state.selected) {
        const item = state.all.get(key);
        if (item) item.el.classList.add('selected');
      }
    }

    function filterList(q) {
      const query = (q||'').toLowerCase().trim();
      if (!query) {
        renderList(Array.from(state.all.values()).map(v => v.label));
        return;
      }
      const labels = Array.from(state.all.values())
        .map(v => v.label)
        .filter(l => l.toLowerCase().includes(query));
      renderList(labels);
    }

    function addFromInput() {
      const raw = searchEl.value.trim();
      if (!raw) return;
      const parts = raw.split(',').map(s => s.trim()).filter(Boolean);
      parts.forEach(p => {
        const key = makeKey(p);
        const el = createBubble(p);
        if (el && !state.selected.has(key)) {
          state.selected.add(key);
          el.classList.add('selected');
        }
      });
      searchEl.value = '';
      filterList('');
      syncHiddenFields();
    }

    function clearSelectionsAndSearch() {
      state.selected.clear();
      state.all.forEach(({ el }) => el.classList.remove('selected'));
      syncHiddenFields();
      searchEl.value = '';
      filterList('');
      searchEl.focus();
    }

    function syncHiddenFields() {
      const prefs = Array.from(state.selected).map(k => state.all.get(k)?.label).filter(Boolean);
      document.getElementById('preferencesField').value = prefs.join(',');
    }

    // Initialize with defaults
    DEFAULT_PREFS.forEach(createBubble);

    // Mark pre-existing selections from user
    const existing = (bubblesEl.dataset.existing || '').split(',').map(s => s.trim()).filter(Boolean);
    existing.forEach(label => {
      const el = createBubble(label);
      const key = makeKey(label);
      if (el && !state.selected.has(key)) {
        state.selected.add(key);
        el.classList.add('selected');
      }
    });

    renderList(Array.from(state.all.values()).map(v => v.label));

    // Events
    searchEl?.addEventListener('input', (e) => filterList(e.target.value));
    searchEl?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); addFromInput(); }
    });
    clearBtn?.addEventListener('click', clearSelectionsAndSearch);

    // Prime hidden field on load
    syncHiddenFields();
  })();
</script>

</body>
</html>