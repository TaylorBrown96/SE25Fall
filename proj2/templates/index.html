<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home · Weeklies</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="{{ url_for('index') }}"><span class="logo"></span> Weeklies</a>
    <nav>
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('profile') }}">Profile</a>
      <a href="{{ url_for('restaurants') }}">Restaurants</a>
      <a href="{{ url_for('db_view') }}">DB</a>
      <a href="{{ url_for('logout') }}" data-confirm="Log out now?">Logout</a>
    </nav>
  </div>
</header>

<main class="main">
  <div class="container">
    <div class="page-title" style="align-items:center; justify-content:space-between;">
      <h1 class="mb-0">Menu Calendar</h1>
      <div class="greet" style="color: var(--muted); font-weight:600;">Welcome, {{ username }}.</div>
    </div>

    {% set meal_names = {1: 'Breakfast', 2: 'Lunch', 3: 'Dinner'} %}
    {% set meal_short = {1: 'B', 2: 'L', 3: 'D'} %}
    {% set has_any = today_menu and (today_menu|length) %}

    <!-- Compact Today's Menu -->
    <div class="card mb-3 compact">
      <div class="card-body">
        <h2 class="h6 mb-1">Today’s Menu ({{ today_year }}-{{ '%02d'|format(today_month) }}-{{ '%02d'|format(today_day) }})</h2>
        {% if has_any %}
          <ul class="list">
            {% for entry in today_menu %}
              <li class="list-item">
                <strong>{{ meal_names.get(entry.meal, 'Meal') }}:</strong>
                {{ entry.item.name }}
                <span class="muted"> · {{ entry.item.restaurant_name }} · ${{ '%.2f'|format(entry.item.price/100) }} · {{ entry.item.calories }} cal</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted mb-0">No menu has been set for today.</p>
        {% endif %}
      </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-wrap calendar-wide">
      <!-- Unified calendar toolbar -->
      <div class="calendar-toolbar" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 8px 0 14px;">
        <div class="cal-title" style="font-weight:700; font-size:1.25rem;">{{ month_name }} {{ year }}</div>
        <div class="btnrow">
          <a class="btn" href="{{ url_for('index', year=prev_year, month=prev_month) }}">&larr; Prev</a>
          <a class="btn btn-outline" href="{{ url_for('index') }}">Today</a>
          <a class="btn" href="{{ url_for('index', year=next_year, month=next_month) }}">Next &rarr;</a>
        </div>
      </div>

      <div class="cal-grid">
        {% for dow in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
          <div class="cal-dow">{{ dow }}</div>
        {% endfor %}

        {# Each cell expects cell.meals: [{meal:1|2|3, item:{...}, color:'#hex'}, ...] #}
        {% for cell in calendar_cells %}
          {% if cell.day == 0 %}
            <div class="day-cell muted"></div>
          {% else %}
            <div class="day-cell{% if year==today_year and month==today_month and cell.day==today_day %} today{% endif %}">
              <div class="day-num">{{ cell.day }}</div>

              {% if cell.meals and cell.meals|length %}
                <div class="badge-stack" style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
                  {% for m in cell.meals %}
                    <div class="badge has-item" title="{{ meal_names.get(m.meal, 'Meal') }}: {{ m.item.name }}">
                      <span class="dot" style="background: {{ m.color }};"></span>
                      <span class="muted" style="opacity:.85; font-weight:700; margin-right:6px;">{{ meal_short.get(m.meal, '?') }}</span>
                      {{ m.item.name }}
                    </div>
                  {% endfor %}
                </div>

                <!-- Hover popover content: ALL meals for the day -->
                <div class="menu-card">
                  <h4 style="font-size: larger; font-weight: bolder;">{{ month_name }} {{ cell.day }}, {{ year }}</h4>
                  <div class="meal-list" style="display:flex; flex-direction:column; gap:12px;">
                    {% for m in cell.meals %}
                      <div class="meal-line">
                        <div class="meal-title" style="font-weight:700; margin-bottom:2px;">
                          {{ meal_names.get(m.meal, 'Meal') }} — {{ m.item.name }}
                        </div>
                        <div class="meta">
                          {{ m.item.restaurant_name }}
                          · ${{ '%.2f'|format(m.item.price/100) }}
                          · {{ m.item.calories }} cal
                        </div>
                        {% if m.item.allergens %}
                          <div class="tags">Allergens: {{ m.item.allergens }}</div>
                        {% endif %}
                        {% if m.item.description %}
                          <div class="tags">{{ m.item.description }}</div>
                        {% endif %}

                        <!-- NEW: Order button per meal -->
                        <div class="actions" style="margin-top:8px;">
                          <a
                            class="order-btn"
                            href="{{ url_for('order') }}?date={{ '%04d-%02d-%02d'|format(year, month, cell.day) }}&meal={{ m.meal }}&itm_id={{ m.item.itm_id }}"
                            aria-label="Order {{ meal_names.get(m.meal, 'Meal') }}"
                          >
                            Order {{ meal_names.get(m.meal, 'Meal') }}
                          </a>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
              {# no else => empty block when no meals #}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="container">© {{ year }} Weeklies</div>
</footer>

<style>
  .calendar-wrap { margin-top: 16px; }
  .greet { font-weight:700; font-size:1.0rem; opacity:.9; }
  .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
  .cal-dow { text-align:center; font-weight:600; opacity:0.7; padding: 6px 0; }

  .day-cell {
    position: relative;
    background: var(--card, #0b1220);
    border: 1px solid rgba(255,255,255,.08);
    min-height: 110px;
    border-radius: var(--radius, 12px);
    padding: 8px;
    overflow: visible;
    z-index: 0;
  }
  .day-cell:hover { z-index: 50; }
  .day-cell.today {
    border-color: rgba(126, 214, 255, .9);
    box-shadow: 0 0 0 2px rgba(126, 214, 255, .35), 0 6px 18px rgba(126, 214, 255, .15) inset;
    background-image: linear-gradient(180deg, rgba(126,214,255,.06), transparent);
  }
  .day-num { font-size:.9rem; opacity:.8; }

  .badge {
    display:inline-block; padding: 6px 8px; border-radius: 10px; font-size:.78rem;
    font-weight:600; margin-top: 6px; background: var(--chip-bg, #1f2a44);
    border: 1px solid rgba(255,255,255,.09); cursor: default;
  }
  .badge.has-item { color: #fff; }
  .badge .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align: middle; }

  .btnrow { display:flex; gap:8px; }
  .btn { text-decoration:none; }

  /* Keep per-day card hidden; script will read its HTML */
  .menu-card { display: none; }

  /* Popover injected by script */
  .menu-popover {
    position: fixed; z-index: 9999;
    width: min(360px, 92vw); background: #0e162b;
    border: 1px solid rgba(255,255,255,.2);
    border-radius: 12px; padding: 12px;
    box-shadow: 0 22px 45px rgba(0,0,0,.55);
    color: #fff; opacity: 0;
    transform: translateY(6px);
    transition: opacity .16s ease, transform .16s ease;
    pointer-events: none;
  }
  .menu-popover.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
  .menu-popover h4 { margin:0 0 6px; font-size:1rem; }
  .menu-popover .meta { font-size:.85rem; opacity:.85; }
  .menu-popover .tags { margin-top:8px; font-size:.78rem; opacity:.9; }
  .menu-popover .arrow {
    position: fixed; width: 12px; height: 12px;
    background: #0e162b;
    border-left: 1px solid rgba(255,255,255,.2);
    border-top: 1px solid rgba(255,255,255,.2);
    transform: rotate(45deg); z-index:10000;
  }

  /* Order button style (kept minimal, matches your palette) */
  .order-btn {
    display:inline-block;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid rgba(91, 140, 255, 0.45);
    text-decoration: none;
    font-size: .85rem;
    font-weight: 700;
    background: rgba(91, 140, 255, 0.12);
    transition: filter .15s ease, transform .02s ease, background .15s ease;
    user-select: none;
  }
  .order-btn:hover { filter: brightness(1.08); }
  .order-btn:active { transform: translateY(1px); }
</style>

<script>
(function () {
  const popover = document.createElement('div');
  popover.className = 'menu-popover';
  const arrow = document.createElement('div');
  arrow.className = 'arrow';
  document.body.appendChild(popover);
  document.body.appendChild(arrow);

  let currentTarget = null, hideTimer = null;

  function clamp(v, min, max){ return Math.min(Math.max(v,min),max); }

  function showPopoverFor(dayCell) {
    const card = dayCell.querySelector('.menu-card');
    if (!card) return;
    popover.innerHTML = card.innerHTML;

    popover.style.visibility = 'hidden';
    popover.classList.add('visible');
    document.body.offsetHeight; // reflow

    const rect = dayCell.getBoundingClientRect();
    const pW = popover.offsetWidth, pH = popover.offsetHeight;
    const vw = window.innerWidth, vh = window.innerHeight;
    const margin=8, side=8;

    // Prefer below; flip above if needed
    let top = rect.bottom + margin, placeAbove=false;
    if (top + pH + side > vh) {
      top = rect.top - pH - margin;
      placeAbove = true;
      if (top < side) top = side;
    }

    // Center horizontally over the day
    let left = rect.left + rect.width/2 - pW/2;
    left = clamp(left, side, vw - pW - side);

    popover.style.left = `${Math.round(left)}px`;
    popover.style.top = `${Math.round(top)}px`;
    popover.style.visibility='visible';

    // Arrow position/orientation
    const arrowSize=12, centerX=rect.left+rect.width/2;
    let arrowLeft = clamp(centerX - arrowSize/2, side, vw - arrowSize - side);
    let arrowTop;
    if (placeAbove) {
      arrowTop = popover.getBoundingClientRect().bottom - 1;
      arrow.style.transform='rotate(225deg)';
    } else {
      arrowTop = popover.getBoundingClientRect().top - arrowSize + 1;
      arrow.style.transform='rotate(45deg)';
    }
    arrow.style.left = `${Math.round(arrowLeft)}px`;
    arrow.style.top = `${Math.round(arrowTop)}px`;
    arrow.style.display='block';

    currentTarget=dayCell;
  }

  function hidePopover(immediate=false){
    if(immediate){
      popover.classList.remove('visible');
      popover.style.visibility='hidden';
      arrow.style.display='none';
      currentTarget=null;
      return;
    }
    clearTimeout(hideTimer);
    hideTimer=setTimeout(()=>{
      popover.classList.remove('visible');
      popover.style.visibility='hidden';
      arrow.style.display='none';
      currentTarget=null;
    },120);
  }

  const grid=document.querySelector('.cal-grid');
  if(!grid) return;

  grid.addEventListener('mouseenter', e=>{
    const cell=e.target.closest('.day-cell'); if(!cell) return;
    clearTimeout(hideTimer);
    showPopoverFor(cell);
  }, true);

  grid.addEventListener('mouseleave', e=>{
    const cell=e.target.closest('.day-cell'); if(!cell) return;
    hidePopover(false);
  }, true);

  popover.addEventListener('mouseenter', ()=>clearTimeout(hideTimer));
  popover.addEventListener('mouseleave', ()=>hidePopover(false));

  // keep position in sync on scroll/resize
  function repositionIfNeeded(){
    if(currentTarget && popover.classList.contains('visible')) showPopoverFor(currentTarget);
  }
  window.addEventListener('scroll', repositionIfNeeded, true);
  window.addEventListener('resize', repositionIfNeeded);

  // Esc to close
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') hidePopover(true); });
})();
</script>

</body>
</html>