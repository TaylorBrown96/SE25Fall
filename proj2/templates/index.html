<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home ¬∑ Weeklies</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="{{ url_for('index') }}"><span class="logo"></span> Weeklies</a>
    <nav>
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('profile') }}">Profile</a>
      <a href="{{ url_for('restaurants') }}">Restaurants</a>
      <a href="{{ url_for('orders') }}">Order</a>
      <a href="{{ url_for('db_view') }}">DB</a>
      <a href="{{ url_for('logout') }}" data-confirm="Log out now?">Logout</a>
    </nav>
  </div>
</header>

<!-- Order Confirm Modal -->
<div id="orderModal" class="order-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="order-modal__backdrop"></div>
  <div class="order-modal__dialog" role="document">
    <div class="order-modal__head">
      <h3 class="order-modal__title">Confirm your order</h3>
      <button type="button" class="order-modal__close" aria-label="Close">&times;</button>
    </div>
    <div class="order-modal__body">
      <div class="order-summary">
        <div class="row"><span class="lbl">Restaurant</span><span class="val" id="om-rtr"></span></div>
        <div class="row"><span class="lbl">Item</span><span class="val" id="om-item"></span></div>
        <div class="row"><span class="lbl">Date</span><span class="val" id="om-date"></span></div>
        <div class="row"><span class="lbl">Meal</span><span class="val" id="om-meal"></span></div>
        <hr />
        <div class="row"><span class="lbl">Subtotal</span><span class="val" id="om-subtotal"></span></div>
        <div class="row"><span class="lbl">Tax</span><span class="val" id="om-tax"></span></div>
        <div class="row"><span class="lbl">Delivery fee</span><span class="val" id="om-delivery"></span></div>
        <div class="row"><span class="lbl">Service fee</span><span class="val" id="om-service"></span></div>
        <div class="row total"><span class="lbl">Total</span><span class="val" id="om-total"></span></div>
      </div>
    </div>
    <div class="order-modal__foot">
      <button type="button" class="btn btn-outline" id="om-cancel">Cancel</button>
      <button type="button" class="btn" id="om-confirm">Place order</button>
    </div>
  </div>
</div>

<main class="main">
  <div class="container">
    <div class="page-title" style="align-items:center; justify-content:space-between;">
      <h1 class="mb-0">Menu Calendar</h1>
      <div class="greet" style="color: var(--muted); font-weight:600;">Welcome, {{ username }}.</div>
    </div>

    {% set meal_names = {1: 'Breakfast', 2: 'Lunch', 3: 'Dinner'} %}
    {% set meal_short = {1: 'B', 2: 'L', 3: 'D'} %}
    {% set has_any = today_menu and (today_menu|length) %}

    <!-- Compact Today's Menu -->
    <div class="card mb-3 compact">
      <div class="card-body">
        <h2 class="h6 mb-1">Today‚Äôs Menu ({{ today_year }}-{{ '%02d'|format(today_month) }}-{{ '%02d'|format(today_day) }})</h2>
        {% if has_any %}
          <ul class="list">
            {% for entry in today_menu %}
              <li class="list-item">
                <strong>{{ meal_names.get(entry.meal, 'Meal') }}:</strong>
                {{ entry.item.name }}
                <span class="muted"> ¬∑ {{ entry.item.restaurant_name }} ¬∑ ${{ '%.2f'|format(entry.item.price/100) }} ¬∑ {{ entry.item.calories }} cal</span>
                {% if entry.item.restaurant_address or entry.item.restaurant_hours or entry.item.restaurant_phone %}
                  <div style="margin-top: 4px; font-size: 0.85rem; color: var(--muted, #a9afc1);">
                    {% if entry.item.restaurant_address %}
                      <span>üìç {{ entry.item.restaurant_address }}</span>
                    {% endif %}
                    {% if entry.item.restaurant_hours %}
                      <span class="rest-hours" data-hours="{{ entry.item.restaurant_hours }}">üïê {{ entry.item.restaurant_hours }}</span>
                    {% endif %}
                    {% if entry.item.restaurant_phone %}
                      <span>üìû {{ entry.item.restaurant_phone }}</span>
                    {% endif %}
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted mb-0">No menu has been set for today.</p>
        {% endif %}
      </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-wrap calendar-wide">
      <!-- Unified calendar toolbar -->
      <div class="calendar-toolbar" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 8px 0 14px;">
        <div class="cal-title" style="font-weight:700; font-size:1.25rem;">{{ month_name }} {{ year }}</div>
        <div class="btnrow">
          <a class="btn" href="{{ url_for('index', year=prev_year, month=prev_month) }}">&larr; Prev</a>
          <a class="btn btn-outline" href="{{ url_for('index') }}">Today</a>
          <a class="btn" href="{{ url_for('index', year=next_year, month=next_month) }}">Next &rarr;</a>
        </div>
      </div>

      <div class="cal-grid">
        {% for dow in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
          <div class="cal-dow">{{ dow }}</div>
        {% endfor %}

        {# Each cell expects cell.meals: [{meal:1|2|3, item:{...}, color:'#hex'}, ...] #}
        {% for cell in calendar_cells %}
          {% if cell.day == 0 %}
            <div class="day-cell muted"></div>
          {% else %}
            <div class="day-cell{% if year==today_year and month==today_month and cell.day==today_day %} today{% endif %}">
              <div class="day-num">{{ cell.day }}</div>

              {% if cell.meals and cell.meals|length %}
                <div class="badge-stack" style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
                  {% for m in cell.meals %}
                    <div class="badge has-item" title="{{ meal_names.get(m.meal, 'Meal') }}: {{ m.item.name }}">
                      <span class="dot" style="background: {{ m.color }};"></span>
                      <span class="muted" style="opacity:.85; font-weight:700; margin-right:6px;">{{ meal_short.get(m.meal, '?') }}</span>
                      {{ m.item.name }}
                    </div>
                  {% endfor %}
                </div>

                <!-- Hover popover content: ALL meals for the day -->
                <div class="menu-card">
                  <h4 style="font-size: larger; font-weight: bolder;">{{ month_name }} {{ cell.day }}, {{ year }}</h4>
                  <div class="meal-list" style="display:flex; flex-direction:column; gap:12px;">
                    {% for m in cell.meals %}
                      <div class="meal-line">
                        <div class="meal-title" style="font-weight:700; margin-bottom:2px;">
                          {{ meal_names.get(m.meal, 'Meal') }} ‚Äî {{ m.item.name }}
                        </div>
                        <div class="meta">
                          {{ m.item.restaurant_name }}
                          ¬∑ ${{ '%.2f'|format(m.item.price/100) }}
                          ¬∑ {{ m.item.calories }} cal
                        </div>
                        {% if m.item.restaurant_address or m.item.restaurant_hours or m.item.restaurant_phone %}
                          <div class="tags" style="margin-top: 4px;">
                            {% if m.item.restaurant_address %}
                              <span>üìç {{ m.item.restaurant_address }}</span>
                            {% endif %}
                            {% if m.item.restaurant_hours %}
                              <span class="rest-hours" style="margin-left: 8px;" data-hours="{{ m.item.restaurant_hours }}">üïê {{ m.item.restaurant_hours }}</span>
                            {% endif %}
                            {% if m.item.restaurant_phone %}
                              <span style="margin-left: 8px;">üìû {{ m.item.restaurant_phone }}</span>
                            {% endif %}
                          </div>
                        {% endif %}
                        {% if m.item.allergens %}
                          <div class="tags">Allergens: {{ m.item.allergens }}</div>
                        {% endif %}
                        {% if m.item.description %}
                          <div class="tags">{{ m.item.description }}</div>
                        {% endif %}

                        <div class="actions" style="margin-top:8px;">
                        <a
                          class="order-btn"
                          href="#"
                          aria-label="Order {{ meal_names.get(m.meal, 'Meal') }}"
                          data-itm-id="{{ m.item.itm_id }}"
                          data-meal="{{ m.meal }}"
                          data-date="{{ '%04d-%02d-%02d'|format(year, month, cell.day) }}"
                          data-rtr-id="{{ m.item.rtr_id }}"
                          data-rtr-name="{{ m.item.restaurant_name }}"
                          data-item-name="{{ m.item.name }}"
                          data-price-cents="{{ m.item.price }}"
                          data-delivery-type="delivery"
                        >
                          Order {{ meal_names.get(m.meal, 'Meal') }}
                        </a>
                      </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
              {# no else => empty block when no meals #}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="container">¬© {{ year }} Weeklies</div>
</footer>

<style>
  .calendar-wrap { margin-top: 24px; }
  .greet { 
    font-weight: 700; 
    font-size: 1.1rem; 
    opacity: .95;
    background: linear-gradient(135deg, rgba(91, 140, 255, 0.15), rgba(126, 214, 255, 0.1));
    padding: 8px 16px;
    border-radius: 10px;
    display: inline-block;
  }
  .cal-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 12px; 
    padding: 4px;
  }
  .cal-dow { 
    text-align: center; 
    font-weight: 700; 
    font-size: 0.85rem;
    opacity: 0.85; 
    padding: 12px 0; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--primary, #5b8cff);
  }

  .day-cell {
    position: relative;
    background: linear-gradient(145deg, #0f1419, #0b0f14);
    border: 1px solid rgba(255,255,255,.06);
    min-height: 125px;
    border-radius: 14px;
    padding: 10px;
    overflow: visible;
    z-index: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .day-cell:hover { 
    z-index: 50; 
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.35), 0 0 0 1px rgba(91, 140, 255, 0.2);
    border-color: rgba(91, 140, 255, 0.3);
  }
  .day-cell.today {
    border-color: rgba(126, 214, 255, .6);
    box-shadow: 0 0 0 2px rgba(126, 214, 255, .4), 0 8px 24px rgba(126, 214, 255, .2), inset 0 1px 0 rgba(255,255,255,.05);
    background: linear-gradient(145deg, rgba(126,214,255,.12), rgba(91,140,255,.08));
  }
  .day-num { 
    font-size: 1rem; 
    font-weight: 700;
    opacity: .9;
    margin-bottom: 6px;
    color: var(--text, #e8eaf2);
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 7px 10px; 
    border-radius: 10px; 
    font-size: 0.8rem;
    font-weight: 600; 
    margin-top: 6px; 
    background: linear-gradient(135deg, rgba(91, 140, 255, 0.15), rgba(126, 214, 255, 0.1));
    border: 1px solid rgba(91, 140, 255, 0.25); 
    cursor: default;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .badge.has-item { 
    color: #fff; 
  }
  .badge:hover {
    transform: translateX(2px);
    box-shadow: 0 4px 10px rgba(91, 140, 255, 0.25);
  }
  .badge .dot { 
    display: inline-block; 
    width: 8px; 
    height: 8px; 
    border-radius: 50%; 
    margin-right: 6px; 
    vertical-align: middle;
    box-shadow: 0 0 6px currentColor;
  }

  .btnrow { display: flex; gap: 10px; }
  .btn { 
    text-decoration: none;
    transition: all 0.2s ease;
  }
  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(91, 140, 255, 0.3);
  }

  /* Keep per-day card hidden; script will read its HTML */
  .menu-card { display: none; }

  /* Popover injected by script */
  .menu-popover {
    position: fixed; 
    z-index: 9999;
    width: min(400px, 92vw); 
    background: linear-gradient(145deg, #0f1419, #0a0d12);
    border: 1px solid rgba(91, 140, 255, 0.3);
    border-radius: 16px; 
    padding: 20px;
    box-shadow: 0 24px 48px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.05);
    color: #fff; 
    opacity: 0;
    transform: translateY(8px) scale(0.98);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    backdrop-filter: blur(10px);
  }
  .menu-popover.visible { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
    pointer-events: auto; 
  }
  .menu-popover h4 { 
    margin: 0 0 12px; 
    font-size: 1.15rem; 
    font-weight: 700;
    background: linear-gradient(135deg, #fff, rgba(255,255,255,.8));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .menu-popover .meta { 
    font-size: 0.9rem; 
    opacity: .85; 
  }
  .menu-popover .tags { 
    margin-top: 10px; 
    font-size: 0.8rem; 
    opacity: .9; 
    padding: 6px 10px;
    background: rgba(91, 140, 255, 0.08);
    border-radius: 8px;
    border: 1px solid rgba(91, 140, 255, 0.15);
  }
  .menu-popover .arrow {
    position: fixed; 
    width: 14px; 
    height: 14px;
    background: linear-gradient(145deg, #0f1419, #0a0d12);
    border-left: 1px solid rgba(91, 140, 255, 0.3);
    border-top: 1px solid rgba(91, 140, 255, 0.3);
    transform: rotate(45deg); 
    z-index: 10000;
    box-shadow: 0 2px 8px rgba(0,0,0,.3);
  }

  /* Order button style - enhanced */
  .order-btn {
    display: inline-block;
    padding: 10px 16px;
    border-radius: 10px;
    border: 1px solid rgba(91, 140, 255, 0.5);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 700;
    background: linear-gradient(135deg, rgba(91, 140, 255, 0.2), rgba(126, 214, 255, 0.15));
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
    box-shadow: 0 4px 12px rgba(91, 140, 255, 0.2);
  }
  .order-btn:hover { 
    filter: brightness(1.15);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(91, 140, 255, 0.35);
    border-color: rgba(91, 140, 255, 0.7);
  }
  .order-btn:active { 
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(91, 140, 255, 0.25);
  }

  /* Today's menu card enhancement */
  .card.compact {
    background: linear-gradient(145deg, #0f1419, #0b0f14);
    border: 1px solid rgba(91, 140, 255, 0.15);
    box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  }
  .card.compact .card-body {
    padding: 18px;
  }

  /* Modal */
  .order-modal { position: fixed; inset: 0; display: none; z-index: 10000; }
  .order-modal[aria-hidden="false"] { display: block; }
  .order-modal__backdrop {
    position: absolute; inset: 0; background: rgba(0,0,0,.55); backdrop-filter: blur(2px);
  }
  .order-modal__dialog {
    position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
    width: min(520px, 92vw); background: #0e162b; color: #fff;
    border: 1px solid rgba(255,255,255,.2); border-radius: 12px; box-shadow: 0 22px 45px rgba(0,0,0,.55);
  }
  .order-modal__head, .order-modal__foot { padding: 12px 14px; display:flex; align-items:center; justify-content:space-between; }
  .order-modal__title { margin: 0; font-size: 1.05rem; }
  .order-modal__close { background: transparent; border: none; color: #fff; font-size: 1.25rem; cursor: pointer; }
  .order-modal__body { padding: 10px 14px 2px; }
  .order-summary .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 6px 0; }
  .order-summary .row.total { font-weight: 800; border-top: 1px dashed rgba(255,255,255,.2); margin-top: 6px; padding-top: 10px; }
  .order-summary .lbl { opacity: .9; }
  .order-summary hr { border: none; border-top: 1px solid rgba(255,255,255,.12); margin: 10px 0; }
</style>

<script>
(function () {
  // Format hours to readable format - defined early
  function formatHours(hoursStr) {
    if (!hoursStr || !hoursStr.trim()) return '';
    let hours = hoursStr.trim();
    hours = hours
      .replace(/monday/gi, 'M')
      .replace(/tuesday/gi, 'T')
      .replace(/wednesday/gi, 'W')
      .replace(/thursday/gi, 'Th')
      .replace(/friday/gi, 'F')
      .replace(/saturday/gi, 'Sa')
      .replace(/sunday/gi, 'Su')
      .replace(/mon(?!\w)/gi, 'M')
      .replace(/tue(?!\w)/gi, 'T')
      .replace(/wed(?!\w)/gi, 'W')
      .replace(/thu(?!\w)/gi, 'Th')
      .replace(/fri(?!\w)/gi, 'F')
      .replace(/sat(?!\w)/gi, 'Sa')
      .replace(/sun(?!\w)/gi, 'Su');
    hours = hours.replace(/([MTWThFSaSu])\s*-\s*([MTWThFSaSu])/g, '$1$2');
    hours = hours.replace(/\s*-\s*/g, ' to ');
    hours = hours.replace(/(\d+)\s*(AM|PM)/gi, (match, num, period) => num + ' ' + period.toLowerCase());
    hours = hours.replace(/\s+/g, ' ').trim();
    if (hours.match(/[MTWThFSaSu]/) && hours.match(/\d/)) return hours;
    return hoursStr.replace(/\s+/g, ' ').trim();
  }

  // ======== Calendar Popover (existing) ========
  const popover = document.createElement('div');
  popover.className = 'menu-popover';
  const arrow = document.createElement('div');
  arrow.className = 'arrow';
  document.body.appendChild(popover);
  document.body.appendChild(arrow);

  let currentTarget = null, hideTimer = null;

  function clamp(v, min, max){ return Math.min(Math.max(v,min),max); }

  function showPopoverFor(dayCell) {
    const card = dayCell.querySelector('.menu-card');
    if (!card) return;
    popover.innerHTML = card.innerHTML;

    popover.style.visibility = 'hidden';
    popover.classList.add('visible');
    document.body.offsetHeight; // reflow

    // Format hours in popover content
    popover.querySelectorAll('.rest-hours[data-hours]').forEach(el => {
      const hrs = el.getAttribute('data-hours');
      if (hrs) {
        const formatted = formatHours(hrs);
        if (formatted) el.textContent = 'üïê ' + formatted;
      }
    });

    const rect = dayCell.getBoundingClientRect();
    const pW = popover.offsetWidth, pH = popover.offsetHeight;
    const vw = window.innerWidth, vh = window.innerHeight;
    const margin=8, side=8;

    // Prefer below; flip above if needed
    let top = rect.bottom + margin, placeAbove=false;
    if (top + pH + side > vh) {
      top = rect.top - pH - margin;
      placeAbove = true;
      if (top < side) top = side;
    }

    // Center horizontally over the day
    let left = rect.left + rect.width/2 - pW/2;
    left = clamp(left, side, vw - pW - side);

    popover.style.left = `${Math.round(left)}px`;
    popover.style.top = `${Math.round(top)}px`;
    popover.style.visibility='visible';

    // Arrow position/orientation
    const arrowSize=12, centerX=rect.left+rect.width/2;
    let arrowLeft = clamp(centerX - arrowSize/2, side, vw - arrowSize - side);
    let arrowTop;
    if (placeAbove) {
      arrowTop = popover.getBoundingClientRect().bottom - 1;
      arrow.style.transform='rotate(225deg)';
    } else {
      arrowTop = popover.getBoundingClientRect().top - arrowSize + 1;
      arrow.style.transform='rotate(45deg)';
    }
    arrow.style.left = `${Math.round(arrowLeft)}px`;
    arrow.style.top = `${Math.round(arrowTop)}px`;
    arrow.style.display='block';

    currentTarget=dayCell;
  }

  function hidePopover(immediate=false){
    if(immediate){
      popover.classList.remove('visible');
      popover.style.visibility='hidden';
      arrow.style.display='none';
      currentTarget=null;
      return;
    }
    clearTimeout(hideTimer);
    hideTimer=setTimeout(()=>{
      popover.classList.remove('visible');
      popover.style.visibility='hidden';
      arrow.style.display='none';
      currentTarget=null;
    },120);
  }

  const grid=document.querySelector('.cal-grid');
  if (grid) {
    grid.addEventListener('mouseenter', e=>{
      const cell=e.target.closest('.day-cell'); if(!cell) return;
      clearTimeout(hideTimer);
      showPopoverFor(cell);
    }, true);

    grid.addEventListener('mouseleave', e=>{
      const cell=e.target.closest('.day-cell'); if(!cell) return;
      hidePopover(false);
    }, true);
  }

  popover.addEventListener('mouseenter', ()=>clearTimeout(hideTimer));
  popover.addEventListener('mouseleave', ()=>hidePopover(false));

  // keep position in sync on scroll/resize
  function repositionIfNeeded(){
    if(currentTarget && popover.classList.contains('visible')) showPopoverFor(currentTarget);
  }
  window.addEventListener('scroll', repositionIfNeeded, true);
  window.addEventListener('resize', repositionIfNeeded);

  // Esc to close popover
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') hidePopover(true); });

  // Format hours in the page on load
  document.querySelectorAll('.rest-hours[data-hours]').forEach(el => {
    const hrs = el.getAttribute('data-hours');
    if (hrs) {
      const formatted = formatHours(hrs);
      if (formatted) el.textContent = 'üïê ' + formatted;
    }
  });


  // ======== Order Confirm Modal (new) ========
  const modal = document.getElementById('orderModal');
  if (!modal) return; // Modal markup must exist in the page

  const omClose = modal.querySelector('.order-modal__close');
  const omCancel = modal.querySelector('#om-cancel');
  const omConfirm = modal.querySelector('#om-confirm');

  const field = id => modal.querySelector('#' + id);
  function dollars(n){ return '$' + (Number(n||0).toFixed(2)); }
  function round2(x){ return Math.round((Number(x)||0)*100)/100; }

  // Fallback computeTotals if global computeGroupTotals isn't present
  function computeTotals(unitPrice, deliveryType){
    const lines = [{ qty: 1, item: { unit_price: Number(unitPrice)||0 } }];
    if (typeof window.computeGroupTotals === 'function') {
      return window.computeGroupTotals(lines, deliveryType || 'delivery', 0);
    }
    const subtotal = round2(lines.reduce((a,l)=>a + (Number(l.qty||1)*Number(l.item.unit_price||0)), 0));
    const tax = round2(subtotal * 0.0725);
    const delivery_fee = (deliveryType==='pickup') ? 0.00 : 3.99;
    const service_fee  = 1.49;
    const tip = 0;
    const total = round2(subtotal + tax + delivery_fee + service_fee + tip);
    return { subtotal, tax, delivery_fee, service_fee, tip, total };
  }

  function openModal(){ modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.setAttribute('aria-hidden','true'); }

  omClose.addEventListener('click', closeModal);
  omCancel.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ 
    if (e.target === modal || e.target === modal.querySelector('.order-modal__backdrop')) closeModal(); 
  });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  let pendingOrder = null;

  // Intercept clicks on any .order-btn (works for items inside the popover)
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.order-btn');
    if (!btn) return;
    e.preventDefault();

    // Gather data from button
    const itmId = Number(btn.dataset.itmId);
    const meal  = Number(btn.dataset.meal || 3);
    const date  = btn.dataset.date;
    const rtrId = Number(btn.dataset.rtrId);
    const rtrName = btn.dataset.rtrName || '';
    const itemName = btn.dataset.itemName || '';
    const priceCents = Number(btn.dataset.priceCents || 0);
    const deliveryType = (btn.dataset.deliveryType || 'delivery').toLowerCase();

    const unitPrice = round2(priceCents / 100.0);
    const totals = computeTotals(unitPrice, deliveryType);

    // Fill modal fields
    field('om-rtr').textContent = rtrName;
    field('om-item').textContent = itemName + ' (x1)';
    field('om-date').textContent = date;
    field('om-meal').textContent = (meal===1 ? 'Breakfast' : meal===2 ? 'Lunch' : 'Dinner');

    field('om-subtotal').textContent = dollars(totals.subtotal);
    field('om-tax').textContent = dollars(totals.tax);
    field('om-delivery').textContent = dollars(totals.delivery_fee);
    field('om-service').textContent = dollars(totals.service_fee);
    field('om-total').textContent = dollars(totals.total);

    // Stash order payload for confirm
    pendingOrder = {
      restaurant_id: rtrId,
      items: [{ itm_id: itmId, qty: 1 }],
      delivery_type: deliveryType,
      tip: 0,
      eta_minutes: 40,
      date,
      meal
    };

    openModal();
  });

  omConfirm.addEventListener('click', async () => {
    if (!pendingOrder) return;
    try {
      const res = await fetch('{{ url_for("order") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pendingOrder)
      });
      const data = await res.json();
      if (data && data.ok) {
        closeModal();
        // redirect to profile with ?ordered=<id> like legacy flow
        window.location.href = '{{ url_for("profile") }}' + (data.ord_id ? ('?ordered=' + data.ord_id) : '');
      } else {
        closeModal();
        alert('Sorry, we could not place your order. Please try again.');
      }
    } catch (err) {
      closeModal();
      alert('Network error placing order.');
    } finally {
      pendingOrder = null;
    }
  });
})();
</script>

</body>
</html>