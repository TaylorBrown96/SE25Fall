<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order · Weeklies</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script defer>
    // --- Data from server (restaurants & items) ---
    window.__RESTS__ = {{ restaurants|tojson }};
    window.__ITEMS__ = {{ items|tojson }};
  </script>
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="{{ url_for('index') }}"><span class="logo" aria-hidden="true"></span> Weeklies</a>
    <nav>
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('profile') }}">Profile</a>
      <!-- Use the restaurant search page route here -->
      <a href="{{ url_for('restaurants') }}">Restaurants</a>
      <a href="{{ url_for('db_view') }}">DB</a>
      <a href="{{ url_for('logout') }}" data-confirm="Log out now?">Logout</a>
    </nav>
  </div>
</header>

<main class="main">
  <div class="container">
    <h1>Build an Order</h1>
    <p class="muted">Pick a restaurant, choose an item, set quantity, and add it to your cookie-based cart. Then review and order below.</p>

    <div class="order-card">
      <div class="row">
        <div class="col">
          <div class="field">
            <label for="restaurantSelect">Restaurant</label>
            <select id="restaurantSelect" required>
              <option value="">Select a restaurant…</option>
            </select>
          </div>
          <div id="restMeta" class="muted"></div>
        </div>

        <div class="col">
          <div class="field">
            <label for="itemSelect">Menu Item</label>
            <select id="itemSelect" required disabled>
              <option value="">Pick a restaurant first…</option>
            </select>
          </div>
          <div id="itemMeta" class="muted"></div>
        </div>

        <div class="col">
          <div class="field">
            <label for="qtyInput">Quantity</label>
            <input id="qtyInput" type="number" min="1" step="1" value="1" />
          </div>

          <div class="field">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" rows="3" placeholder="e.g., Extra napkins, light sauce, no onions"></textarea>
          </div>

          <div class="inline">
            <button id="addBtn" class="btn" type="button">Add to Order</button>
            <a class="btn secondary" href="#" id="viewCartBtn">View Cart (cookie)</a>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div id="preview" class="muted"></div>
    </div>

    <!-- CART RENDER -->
    <section id="cartSection" style="margin-top:20px;">
      <h2 class="h5">Your Cart</h2>
      <p class="muted" id="cartEmptyMsg" style="display:none;">Your cart is empty. Add something above to get started.</p>
      <div id="cartGroups"></div>

      <div class="inline" style="margin-top:12px;">
        <button id="clearCartBtn" class="btn secondary" type="button">Clear Cart</button>
      </div>
    </section>
  </div>
</main>

<footer class="footer">
  <div class="container">© {{ year if year is defined else 2025 }} Weeklies</div>
</footer>

<div id="toast" class="toast">Added to order.</div>

<style>
  .order-card { background: var(--surface, #10131b); border:1px solid var(--border,#232638);
    border-radius:12px; padding:14px; box-shadow: var(--shadow-md, 0 6px 20px rgba(0,0,0,.25)); }
  .row { display:flex; gap:14px; flex-wrap:wrap; }
  .col { flex:1 1 280px; min-width:260px; }
  .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
  .field label { font-weight:700; opacity:.9; }
  select, input[type="number"], textarea {
    background:#0b1220; color:#e8eaf2; border:1px solid rgba(255,255,255,.1);
    border-radius:10px; padding:10px; font-size:0.95rem;
  }
  .muted { color: var(--muted, #a9afc1); }
  .price { font-weight:800; letter-spacing:.2px; }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:.8rem; border:1px solid rgba(255,255,255,.12); }
  .btn { display:inline-block; padding:10px 14px; border-radius:10px; text-decoration:none; cursor:pointer;
    border:1px solid rgba(91,140,255,.45); background: rgba(91,140,255,.12); font-weight:800; }
  .btn:hover { filter: brightness(1.08); }
  .btn.secondary { border-color: rgba(255,255,255,.2); background: rgba(255,255,255,.06); }
  .inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .divider { height:1px; background: var(--border,#232638); margin: 10px 0 14px; }
  .toast {
    position: fixed; right: 16px; bottom: 16px; background: #0e162b; border:1px solid rgba(255,255,255,.2);
    color:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,.45);
    opacity:0; transform: translateY(6px); transition: all .18s ease; z-index: 9999;
  }
  .toast.show { opacity:1; transform: translateY(0); }
</style>

<script>
  // ---------- Cookie helpers ----------
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + days*24*60*60*1000);
    document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
  }
  function getCookie(name) {
    const cname = name + "=";
    const decoded = decodeURIComponent(document.cookie);
    const parts = decoded.split(';');
    for (let c of parts) {
      while (c.charAt(0) === ' ') c = c.substring(1);
      if (c.indexOf(cname) === 0) return c.substring(cname.length, c.length);
    }
    return null;
  }

  // ---------- Money & math ----------
  function centsToDollars(c) { return (c/100).toFixed(2); }
  function toMoney(n) { return Number.parseFloat(n).toFixed(2); }
  function round2(n) { return Math.round((n + Number.EPSILON) * 100) / 100; }

  // ---------- Data ----------
  const RESTS = window.__RESTS__ || [];
  const ITEMS = window.__ITEMS__ || [];
  const byRestaurant = new Map();
  for (const it of ITEMS) {
    if (!byRestaurant.has(it.rtr_id)) byRestaurant.set(it.rtr_id, []);
    byRestaurant.get(it.rtr_id).push(it);
  }

  // ---------- DOM refs ----------
  const selRest   = document.getElementById('restaurantSelect');
  const selItem   = document.getElementById('itemSelect');
  const restMeta  = document.getElementById('restMeta');
  const itemMeta  = document.getElementById('itemMeta');
  const qtyInput  = document.getElementById('qtyInput');
  const notesEl   = document.getElementById('notes');
  const preview   = document.getElementById('preview');
  const cartGroupsWrap = document.getElementById('cartGroups');
  const cartEmptyMsg   = document.getElementById('cartEmptyMsg');

  // ---------- UI helpers ----------
  function showToast(msg) {
    let t = document.getElementById('toast');
    if (!t) {
      t = document.createElement('div');
      t.id = 'toast';
      t.className = 'toast';
      document.body.appendChild(t);
    }
    t.textContent = msg || 'Added.';
    requestAnimationFrame(() => {
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1200);
    });
  }

  function formatAddress(r) {
    if (!r) return '';
    // Prefer server-built address_full if present
    if (r.address_full) return r.address_full;
    const parts = [r.address, r.city, r.state, r.zip].filter(Boolean);
    return parts.join(', ');
  }

  // ---------- Item selector (restaurant select is populated by JS from RESTS) ----------
  function populateRestaurants() {
    // avoid duplicating options if called twice
    const have = new Set(Array.from(selRest.options).map(o => o.value));
    for (const r of RESTS) {
      if (have.has(String(r.rtr_id))) continue;
      const opt = document.createElement('option');
      opt.value = r.rtr_id;
      opt.textContent = r.name;
      selRest.appendChild(opt);
    }
  }
  function populateItemsFor(rtrId) {
    selItem.innerHTML = '';
    const def = document.createElement('option');
    def.value = '';
    def.textContent = rtrId ? 'Select an item…' : 'Pick a restaurant first…';
    selItem.appendChild(def);

    if (!rtrId) { selItem.disabled = true; itemMeta.textContent=''; return; }
    const list = byRestaurant.get(Number(rtrId)) || [];
    for (const it of list) {
      const opt = document.createElement('option');
      opt.value = it.itm_id;
      opt.textContent = `${it.name} — $${centsToDollars(it.price_cents)}`;
      selItem.appendChild(opt);
    }
    selItem.disabled = list.length === 0;
    if (list.length === 0) itemMeta.textContent = 'No in-stock items for this restaurant.';
  }
  function updatePreview() {
    const rtrId = Number(selRest.value || 0);
    const itmId = Number(selItem.value || 0);
    const qty = Math.max(1, Number(qtyInput.value || 1));
    const r = RESTS.find(x => x.rtr_id === rtrId);
    const it = (byRestaurant.get(rtrId) || []).find(x => x.itm_id === itmId);

    if (!r) { preview.textContent = ''; restMeta.textContent=''; return; }
    const addr = formatAddress(r);
    restMeta.innerHTML = `
      <div class="pill">${r.name}</div>
      ${addr ? `<div class="muted" style="margin-top:4px;">${addr}</div>` : ''}
    `;
    if (it) {
      const price = centsToDollars(it.price_cents);
      const total = (qty * (it.price_cents/100)).toFixed(2);
      itemMeta.innerHTML = `
        <div><strong>${it.name}</strong> · <span class="price">$${price}</span></div>
        <div class="muted">Calories: ${it.calories || 0}${it.allergens ? ' · Allergens: ' + it.allergens : ''}</div>
        ${it.description ? `<div class="muted">${it.description}</div>` : ''}
      `;
      preview.innerHTML = `Qty <strong>${qty}</strong> × $${price} = <strong>$${total}</strong>`;
    } else {
      itemMeta.textContent = '';
      preview.textContent = '';
    }
  }

  selRest.addEventListener('change', () => {
    populateItemsFor(selRest.value);
    selItem.value = '';
    itemMeta.textContent = '';
    preview.textContent = '';
    updatePreview();
  });
  selItem.addEventListener('change', updatePreview);
  qtyInput.addEventListener('input', updatePreview);

  populateRestaurants();
  populateItemsFor(null);

  // ---------- Cart (cookie) ----------
  function readCart() {
    try {
      const raw = getCookie('cart');
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch { return []; }
  }
  function writeCart(arr) {
    setCookie('cart', JSON.stringify(arr), 7);
  }

  // Add line
  document.getElementById('addBtn').addEventListener('click', () => {
    const rtrId = Number(selRest.value || 0);
    const itmId = Number(selItem.value || 0);
    const qty   = Math.max(1, Number(qtyInput.value || 1));
    const note  = (notesEl.value || '').trim();
    if (!rtrId) { showToast('Pick a restaurant'); return; }
    if (!itmId) { showToast('Pick a menu item'); return; }

    const r  = RESTS.find(x => x.rtr_id === rtrId);
    const it = (byRestaurant.get(rtrId) || []).find(x => x.itm_id === itmId);
    if (!r || !it) { showToast('Invalid selection'); return; }

    const cart = readCart();
    // Enforce single-restaurant cart: if cart has items from a different restaurant, block
    const other = cart.find(l => Number(l.restaurant_id) !== rtrId);
    if (cart.length && other) { showToast('Cart locked to another restaurant. Clear cart to switch.'); return; }

    const existing = cart.find(l => l.restaurant_id===rtrId && l.item.itm_id===itmId && (l.notes||'')===note);
    if (existing) {
      existing.qty = (existing.qty||1) + qty;
    } else {
      cart.push({
        restaurant_id: rtrId,
        restaurant_name: r.name,
        item: { itm_id: it.itm_id, name: it.name, unit_price: (it.price_cents/100).toFixed(2) },
        qty, notes: note
      });
    }
    writeCart(cart);
    showToast('Added to order');
    renderCart();
  });

  document.getElementById('viewCartBtn').addEventListener('click', (e) => {
    e.preventDefault();
    const raw = getCookie('cart');
    if (!raw) { alert('Cart is empty'); return; }
    try { alert('Cart:\n' + JSON.stringify(JSON.parse(raw), null, 2)); }
    catch { alert('Cart cookie is not valid JSON'); }
  });

  document.getElementById('clearCartBtn').addEventListener('click', () => {
    if (!confirm('Clear your entire cart?')) return;
    writeCart([]);
    renderCart();
  });

  // ---------- Fees & totals per restaurant group ----------
  function computeGroupTotals(lines, deliveryType='delivery', tipDollar=0) {
    const subtotal = round2(lines.reduce((acc, l) => acc + (Number(l.qty||1) * Number(l.item.unit_price||0)), 0));
    const tax = round2(subtotal * 0.0725);
    const delivery_fee = deliveryType === 'delivery' ? 3.99 : 0.00;
    const service_fee  = 1.49;
    const tip = round2(Number(tipDollar||0));
    const total = round2(subtotal + tax + delivery_fee + service_fee + tip);
    return { subtotal, tax, delivery_fee, service_fee, tip, total };
  }

  async function placeGroupOrder(rtrId, lines, deliveryType, tipDollar) {
    // Build payload for POST
    const payload = {
      restaurant_id: Number(rtrId),
      items: lines.map(l => ({
        itm_id: Number(l.item.itm_id),
        qty: Number(l.qty||1),
        notes: l.notes || ''
      })),
      delivery_type: deliveryType,
      tip: Number(tipDollar||0),
      eta_minutes: 40,
      date: new Date().toISOString().slice(0,10),
      meal: 3
    };

    try {
      const res = await fetch(`{{ url_for('order') }}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Order failed');
      const data = await res.json(); // expects {ok:true, ord_id:...}
      showToast('Order placed!');
      // Remove this restaurant's lines from cart (or clear all if single-restaurant policy)
      const cart = readCart().filter(l => Number(l.restaurant_id) !== Number(rtrId));
      writeCart(cart);
      // Redirect to profile (orders list) or just re-render:
      window.location.href = "{{ url_for('profile') }}";
    } catch (e) {
      showToast('Could not place order');
      console.error(e);
    }
  }

  // ---------- Render cart grouped by restaurant ----------
  function renderCart() {
    const cart = readCart();
    cartEmptyMsg.style.display = cart.length ? 'none' : 'block';
    cartGroupsWrap.innerHTML = '';
    if (!cart.length) return;

    // group lines by restaurant_id
    const groups = new Map();
    for (const l of cart) {
      if (!groups.has(l.restaurant_id)) groups.set(l.restaurant_id, []);
      groups.get(l.restaurant_id).push(l);
    }

    // build each group block
    groups.forEach((lines, rtrId) => {
      const title = lines[0]?.restaurant_name || `Restaurant #${rtrId}`;
      const groupEl = document.createElement('div');
      groupEl.className = 'order-card';
      groupEl.style.marginTop = '12px';

      let deliveryType = 'delivery';
      let tipDollar = 0;

      function updateSummary() {
        const totals = computeGroupTotals(lines, deliveryType, tipDollar);
        sumEl.innerHTML = `
          <div><strong>Subtotal:</strong> $${toMoney(totals.subtotal)}</div>
          <div><strong>Tax (7.25%):</strong> $${toMoney(totals.tax)}</div>
          <div><strong>Delivery fee:</strong> $${toMoney(totals.delivery_fee)} &nbsp; <span class="muted">(${deliveryType})</span></div>
          <div><strong>Service fee:</strong> $${toMoney(totals.service_fee)}</div>
          <div><strong>Tip:</strong> $${toMoney(totals.tip)}</div>
          <div style="margin-top:6px;font-size:1.05rem;"><strong>Total:</strong> $${toMoney(totals.total)}</div>
        `;
      }

      const head = document.createElement('div');
      head.className = 'inline';
      head.style.justifyContent = 'space-between';

      const rInfo = RESTS.find(x => Number(x.rtr_id) === Number(rtrId));
      const addrLine = formatAddress(rInfo);

      head.innerHTML = `
        <div>
          <div style="font-weight:800;">${title}</div>
          ${addrLine ? `<div class="muted" style="margin-top:2px;">${addrLine}</div>` : ''}
        </div>
        <div class="inline">
          <label class="muted" for="deliver-${rtrId}">Type:</label>
          <select id="deliver-${rtrId}">
            <option value="delivery">Delivery</option>
            <option value="pickup">Pickup</option>
          </select>
          <label class="muted" for="tip-${rtrId}">Tip $</label>
          <input id="tip-${rtrId}" type="number" min="0" step="0.25" value="0.00" style="width:90px;">
        </div>
      `;

      const table = document.createElement('div');
      for (let i = 0; i < lines.length; i++) {
        const l = lines[i];
        const row = document.createElement('div');
        row.className = 'inline';
        row.style.justifyContent = 'space-between';
        row.style.padding = '6px 0';
        row.style.borderBottom = '1px solid var(--border, #232638)';

        const left = document.createElement('div');
        left.innerHTML = `
          <div><strong>${l.item.name}</strong> &nbsp; <span class="muted">($${toMoney(l.item.unit_price)})</span></div>
          ${l.notes ? `<div class="muted" style="font-size:.9rem;">Note: ${l.notes}</div>` : ''}
        `;

        const right = document.createElement('div');
        right.className = 'inline';
        right.innerHTML = `
          <input type="number" min="1" step="1" value="${l.qty||1}" style="width:80px" aria-label="Quantity">
          <div style="width:90px; text-align:right;">$${toMoney((l.qty||1)*Number(l.item.unit_price||0))}</div>
          <button class="btn secondary" type="button" aria-label="Remove">Remove</button>
        `;

        // qty edit / remove
        const qtyInput = right.querySelector('input');
        qtyInput.addEventListener('input', () => {
          const val = Math.max(1, Number(qtyInput.value||1));
          l.qty = val;
          writeCart(readCart()); // persist change
          right.querySelector('div').textContent = '$' + toMoney(val * Number(l.item.unit_price||0));
          updateSummary();
        });

        right.querySelector('button').addEventListener('click', () => {
          if (!confirm('Remove this item?')) return;
          const full = readCart();
          const idx = full.indexOf(l);
          // fallback match if reference lost
          const idx2 = idx >= 0 ? idx : full.findIndex(x => x.restaurant_id===l.restaurant_id && x.item.itm_id===l.item.itm_id && (x.notes||'')===(l.notes||''));
          if (idx2 >= 0) full.splice(idx2,1);
          writeCart(full);
          renderCart();
        });

        row.appendChild(left);
        row.appendChild(right);
        table.appendChild(row);
      }

      const sumEl = document.createElement('div');
      sumEl.style.marginTop = '10px';

      const footer = document.createElement('div');
      footer.className = 'inline';
      footer.style.marginTop = '10px';
      const orderAllBtn = document.createElement('a');
      orderAllBtn.className = 'btn';
      orderAllBtn.textContent = 'Place Order';
      orderAllBtn.href = '#';
      orderAllBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (!lines.length) { showToast('No items to order'); return; }
        placeGroupOrder(rtrId, lines, deliveryType, tipDollar);
      });

      footer.appendChild(orderAllBtn);

      groupEl.appendChild(head);
      groupEl.appendChild(table);
      groupEl.appendChild(sumEl);
      groupEl.appendChild(footer);

      head.querySelector(`#deliver-${rtrId}`).addEventListener('change', (ev) => {
        deliveryType = ev.target.value === 'pickup' ? 'pickup' : 'delivery';
        updateSummary();
      });
      head.querySelector(`#tip-${rtrId}`).addEventListener('input', (ev) => {
        const v = Number(ev.target.value || 0);
        tipDollar = v >= 0 ? v : 0;
        updateSummary();
      });

      updateSummary();
      cartGroupsWrap.appendChild(groupEl);
    });
  }

  // initial render
  updatePreview();
  renderCart();
</script>


</body>
</html>