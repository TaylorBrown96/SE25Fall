<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restaurants ¬∑ Weeklies</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script defer>
    window.__RESTS__ = {{ restaurants|tojson }};
    window.__ITEMS__ = {{ items|tojson }};
  </script>
  <style>
    .search-bar { margin-bottom: 24px; }
    .search-bar input { 
      width: 100%; 
      max-width: 600px; 
      padding: 14px 18px; 
      border-radius: 12px; 
      background: linear-gradient(145deg, #0f1419, #0b0f14);
      border: 1px solid rgba(91, 140, 255, 0.2); 
      color: #e8eaf2; 
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .search-bar input:focus { 
      outline: none; 
      border-color: rgba(91,140,255,.6);
      box-shadow: 0 6px 20px rgba(91, 140, 255, 0.25), 0 0 0 3px rgba(91, 140, 255, 0.1);
      transform: translateY(-1px);
    }
    .search-bar input::placeholder {
      color: rgba(169, 175, 193, 0.5);
    }
    
    .accordion { margin-bottom: 16px; }
    .accordion-header { 
      background: linear-gradient(145deg, #0f1419, #0b0f14);
      border: 1px solid rgba(91, 140, 255, 0.15);
      border-radius: 14px; 
      padding: 18px 20px; 
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .accordion-header:hover { 
      background: linear-gradient(145deg, rgba(91, 140, 255, 0.12), rgba(126, 214, 255, 0.08));
      border-color: rgba(91,140,255,.4);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(91, 140, 255, 0.25);
    }
    .accordion-header.active { 
      border-bottom-left-radius: 0; 
      border-bottom-right-radius: 0; 
      border-bottom: none;
      border-color: rgba(91,140,255,.5);
      background: linear-gradient(145deg, rgba(91, 140, 255, 0.15), rgba(126, 214, 255, 0.1));
    }
    .accordion-header h3 { 
      margin: 0; 
      font-size: 1.2rem; 
      font-weight: 700;
      background: linear-gradient(135deg, #fff, rgba(255,255,255,.9));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .accordion-header .meta-info { 
      color: var(--muted, #a9afc1); 
      font-size: 0.9rem; 
      margin-top: 8px;
      line-height: 1.6;
    }
    .accordion-header .meta-info div {
      margin-top: 4px;
    }
    .accordion-header .icon { 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      font-size: 1.3rem;
      color: rgba(91, 140, 255, 0.8);
    }
    .accordion-header.active .icon { 
      transform: rotate(180deg);
      color: rgba(91, 140, 255, 1);
    }
    
    .accordion-content { 
      background: linear-gradient(145deg, #0f1419, #0b0f14);
      border: 1px solid rgba(91, 140, 255, 0.15);
      border-top: none; 
      border-radius: 0 0 14px 14px; 
      padding: 20px; 
      display: none; 
      max-height: 0; 
      overflow: hidden; 
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 4px 12px rgba(0,0,0,0.15);
    }
    .accordion-content.active { 
      display: block; 
      max-height: 5000px;
      animation: slideDown 0.4s ease-out;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .menu-item { 
      display: flex; 
      align-items: flex-start; 
      justify-content: space-between; 
      gap: 16px; 
      padding: 16px; 
      margin-bottom: 12px;
      background: linear-gradient(145deg, rgba(91, 140, 255, 0.06), rgba(126, 214, 255, 0.03));
      border: 1px solid rgba(91, 140, 255, 0.1);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .menu-item:hover {
      background: linear-gradient(145deg, rgba(91, 140, 255, 0.12), rgba(126, 214, 255, 0.06));
      border-color: rgba(91, 140, 255, 0.25);
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(91, 140, 255, 0.15);
    }
    .menu-item:last-child { margin-bottom: 0; }
    .menu-item .left { flex: 1; }
    .menu-item .name { 
      font-weight: 700; 
      font-size: 1.1rem; 
      margin-bottom: 6px;
      color: #fff;
    }
    .menu-item .desc { 
      color: var(--muted, #a9afc1); 
      font-size: 0.9rem; 
      line-height: 1.5; 
    }
    .menu-item .right { 
      text-align: right; 
      min-width: 150px; 
    }
    .menu-item .price { 
      font-weight: 800; 
      font-size: 1.2rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #5b8cff, #7ed6ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .menu-item .add-controls { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      justify-content: flex-end;
    }
    .menu-item input[type="number"] { 
      width: 75px; 
      padding: 8px; 
      border-radius: 8px; 
      background: #0b1220; 
      color: #e8eaf2; 
      border: 1px solid rgba(91, 140, 255, 0.2);
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .menu-item input[type="number"]:focus {
      border-color: rgba(91, 140, 255, 0.5);
      box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.1);
    }
    
    .btn { 
      display: inline-block; 
      padding: 10px 16px; 
      border-radius: 10px; 
      text-decoration: none; 
      cursor: pointer; 
      border: 1px solid rgba(91,140,255,.5); 
      background: linear-gradient(135deg, rgba(91, 140, 255, 0.2), rgba(126, 214, 255, 0.15));
      font-weight: 800; 
      font-size: 0.9rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(91, 140, 255, 0.2);
    }
    .btn:hover { 
      filter: brightness(1.15);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(91, 140, 255, 0.35);
      border-color: rgba(91, 140, 255, 0.7);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn.secondary { 
      border-color: rgba(255,255,255,.25); 
      background: rgba(255,255,255,.08);
    }
    .btn.secondary:hover {
      background: rgba(255,255,255,.12);
      box-shadow: 0 4px 12px rgba(255,255,255,0.1);
    }
    
    .layout { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 24px; 
    }
    @media (min-width: 900px) { 
      .layout { grid-template-columns: 2fr 1fr; } 
    }
    
    .order-card { 
      background: linear-gradient(145deg, #0f1419, #0b0f14);
      border: 1px solid rgba(91, 140, 255, 0.2);
      border-radius: 16px; 
      padding: 20px; 
      position: sticky; 
      top: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .order-card h2 {
      margin-top: 0;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #fff, rgba(255,255,255,.9));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .inline { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      flex-wrap: wrap; 
    }
    
    .toast { 
      position: fixed; 
      right: 16px; 
      bottom: 16px; 
      background: linear-gradient(145deg, #0f1419, #0b0f14);
      border: 1px solid rgba(91, 140, 255, 0.3);
      color: #fff; 
      padding: 14px 18px; 
      border-radius: 12px; 
      box-shadow: 0 12px 32px rgba(91, 140, 255, 0.3);
      opacity: 0; 
      transform: translateY(6px); 
      transition: all .25s cubic-bezier(0.4, 0, 0.2, 1); 
      z-index: 9999; 
      font-weight: 600;
    }
    .toast.show { 
      opacity: 1; 
      transform: translateY(0); 
    }
    
    .restaurant-info { margin-top: 8px; font-size: 0.85rem; }
    .restaurant-info div { margin-top: 4px; }
    
    .cart-input { 
      background: #0b1220 !important; 
      color: #e8eaf2 !important; 
      border: 1px solid rgba(91, 140, 255, 0.2) !important; 
      padding: 8px !important; 
      border-radius: 8px !important;
      transition: all 0.2s ease !important;
    }
    .cart-input:focus {
      border-color: rgba(91, 140, 255, 0.5) !important;
      box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.1) !important;
    }
    
    select.cart-select { 
      background: #0b1220 !important; 
      color: #e8eaf2 !important; 
      border: 1px solid rgba(91, 140, 255, 0.2) !important; 
      padding: 8px !important; 
      border-radius: 8px !important;
      transition: all 0.2s ease !important;
    }
    select.cart-select:focus {
      border-color: rgba(91, 140, 255, 0.5) !important;
      box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.1) !important;
    }
    
    /* Page title enhancement */
    .main h1 {
      background: linear-gradient(135deg, #fff, rgba(255,255,255,.85));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2rem;
      margin-bottom: 8px;
    }
    
    .main .meta {
      color: var(--muted, #a9afc1);
      font-size: 1rem;
      line-height: 1.6;
    }
  </style>
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="{{ url_for('index') }}"><span class="logo" aria-hidden="true"></span> Weeklies</a>
    <nav>
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('profile') }}">Profile</a>
      <a href="{{ url_for('restaurants') }}">Restaurants</a>
      <a href="{{ url_for('orders') }}">Order</a>
      <a href="{{ url_for('db_view') }}">DB</a>
      <a href="{{ url_for('logout') }}" data-confirm="Log out now?">Logout</a>
    </nav>
  </div>
</header>

<main class="main">
  <div class="container">
    <h1>Restaurants</h1>
    <p class="meta">Browse restaurants and add menu items to your cart. Click on a restaurant name to view its menu.</p>

    <div class="layout">
      <section>
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Search restaurants or menu items..." />
        </div>
        <div id="restList"></div>
      </section>

      <aside>
        <section id="cartSection" class="order-card">
          <h2 class="h5">Your Cart</h2>
          <p class="meta" id="cartEmptyMsg" style="display:none;">Your cart is empty. Add items to begin.</p>
          <div id="cartGroups"></div>
          <div class="inline" style="margin-top:12px;">
            <button id="clearCartBtn" class="btn secondary" type="button">Clear Cart</button>
          </div>
        </section>
      </aside>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="container">¬© {{ year if year is defined else 2025 }} Weeklies</div>
</footer>

<div id="toast" class="toast">Added to cart.</div>

<script>
  // ---------- Data ----------
  const RESTS = window.__RESTS__ || [];
  const ITEMS = window.__ITEMS__ || [];
  const byRestaurant = new Map();
  for (const it of ITEMS) {
    if (!byRestaurant.has(it.rtr_id)) byRestaurant.set(it.rtr_id, []);
    byRestaurant.get(it.rtr_id).push(it);
  }

  // ---------- Cookie helpers ----------
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + days*24*60*60*1000);
    document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
  }
  function getCookie(name) {
    const cname = name + "=";
    const decoded = decodeURIComponent(document.cookie);
    const parts = decoded.split(';');
    for (let c of parts) {
      while (c.charAt(0) === ' ') c = c.substring(1);
      if (c.indexOf(cname) === 0) return c.substring(cname.length, c.length);
    }
    return null;
  }
  function readCart(){ try { const raw = getCookie('cart'); if (!raw) return []; const j = JSON.parse(raw); return Array.isArray(j) ? j : []; } catch { return []; } }
  function writeCart(arr){ setCookie('cart', JSON.stringify(arr), 7); }

  // ---------- UI helpers ----------
  function showToast(msg){ const t=document.getElementById('toast'); t.textContent = msg || 'Added.'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }
  function toMoney(n){ return Number.parseFloat(n).toFixed(2); }
  function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
  function formatAddress(r){ if (!r) return ''; if (r.address_full) return r.address_full; const parts=[r.address,r.city,r.state,r.zip].filter(Boolean); return parts.join(', '); }
  
  // Format hours to readable format like "MTW 11 to 4, Th F 2 to 9 pm"
  function formatHours(hoursStr) {
    if (!hoursStr || !hoursStr.trim()) return '';
    
    let hours = hoursStr.trim();
    
    // Normalize day names to abbreviations
    hours = hours
      .replace(/monday/gi, 'M')
      .replace(/tuesday/gi, 'T')
      .replace(/wednesday/gi, 'W')
      .replace(/thursday/gi, 'Th')
      .replace(/friday/gi, 'F')
      .replace(/saturday/gi, 'Sa')
      .replace(/sunday/gi, 'Su')
      .replace(/mon(?!\w)/gi, 'M')
      .replace(/tue(?!\w)/gi, 'T')
      .replace(/wed(?!\w)/gi, 'W')
      .replace(/thu(?!\w)/gi, 'Th')
      .replace(/fri(?!\w)/gi, 'F')
      .replace(/sat(?!\w)/gi, 'Sa')
      .replace(/sun(?!\w)/gi, 'Su');
    
    // Clean up dashes between days - replace with space or comma
    hours = hours.replace(/([MTWThFSaSu])\s*-\s*([MTWThFSaSu])/g, '$1$2');
    
    // Normalize time separators
    hours = hours.replace(/\s*-\s*/g, ' to ');
    hours = hours.replace(/\s*:\s*/g, ':');
    
    // Normalize am/pm to lowercase  
    hours = hours.replace(/(\d+)\s*(AM|PM)/gi, (match, num, period) => num + ' ' + period.toLowerCase());
    
    // Clean up multiple spaces
    hours = hours.replace(/\s+/g, ' ').trim();
    
    // If format looks good (has day abbreviations and times), return it
    if (hours.match(/[MTWThFSaSu]/) && hours.match(/\d/)) {
      return hours;
    }
    
    // Fallback: just clean up spaces
    return hoursStr.replace(/\s+/g, ' ').trim();
  }

  // ---------- Search functionality ----------
  let searchTerm = '';
  function filterRestaurantsAndItems(term) {
    searchTerm = (term || '').toLowerCase().trim();
    renderRestaurants();
  }

  function matchesSearch(r, items) {
    if (!searchTerm) return true;
    const rNameMatch = r.name.toLowerCase().includes(searchTerm);
    const rDescMatch = (r.description || '').toLowerCase().includes(searchTerm);
    const rAddrMatch = formatAddress(r).toLowerCase().includes(searchTerm);
    if (rNameMatch || rDescMatch || rAddrMatch) return true;
    
    for (const it of items) {
      if (it.name.toLowerCase().includes(searchTerm) || 
          (it.description || '').toLowerCase().includes(searchTerm)) {
        return true;
      }
    }
    return false;
  }

  // ---------- Build restaurant accordion list ----------
  const restListEl = document.getElementById('restList');
  function renderRestaurants(){
    restListEl.innerHTML = '';
    
    const filteredRests = RESTS.filter(r => {
      const items = (byRestaurant.get(r.rtr_id) || []);
      return matchesSearch(r, items);
    });

    if (filteredRests.length === 0) {
      restListEl.innerHTML = '<div class="meta" style="text-align:center; padding:40px;">No restaurants or items match your search.</div>';
      return;
    }

    for (const r of filteredRests) {
      const accordion = document.createElement('div');
      accordion.className = 'accordion';
      accordion.dataset.rtrId = r.rtr_id;

      const header = document.createElement('div');
      header.className = 'accordion-header';
      header.setAttribute('role', 'button');
      header.setAttribute('aria-expanded', 'false');
      
      const addr = formatAddress(r);
      const formattedHours = r.hours ? formatHours(r.hours) : '';
      const infoHtml = `
        <div>
          <h3>${r.name}</h3>
          <div class="meta-info">
            ${addr ? `<div>üìç ${addr}</div>` : ''}
            ${formattedHours ? `<div>üïê ${formattedHours}</div>` : ''}
            ${r.phone ? `<div>üìû ${r.phone}</div>` : ''}
            ${r.status ? `<div>Status: ${r.status}</div>` : ''}
          </div>
        </div>
      `;
      header.innerHTML = infoHtml + '<span class="icon">‚ñº</span>';

      const content = document.createElement('div');
      content.className = 'accordion-content';
      content.id = `content-${r.rtr_id}`;

      const items = (byRestaurant.get(r.rtr_id) || []).filter(it => {
        if (!searchTerm) return true;
        return it.name.toLowerCase().includes(searchTerm) || 
               (it.description || '').toLowerCase().includes(searchTerm);
      });

      if (!items.length) {
        content.innerHTML = '<div class="meta" style="padding:12px;">No menu items available' + (searchTerm ? ' matching your search' : '') + '.</div>';
      } else {
        for (const it of items) {
          const row = document.createElement('div');
          row.className = 'menu-item';
          row.innerHTML = `
            <div class="left">
              <div class="name">${it.name}</div>
              <div class="desc">
                ${it.description || ''}${it.allergens ? ` ¬∑ Allergens: ${it.allergens}` : ''}${it.calories ? ` ¬∑ ${it.calories} cal` : ''}
              </div>
            </div>
            <div class="right">
              <div class="price">$${toMoney((it.price_cents||0)/100)}</div>
              <div class="add-controls">
                <input type="number" min="1" step="1" value="1" aria-label="Quantity">
                <button class="btn" type="button">Add</button>
              </div>
            </div>
          `;
          const qtyEl = row.querySelector('input');
          row.querySelector('button').addEventListener('click', () => {
            const qty = Math.max(1, Number(qtyEl.value||1));
            addToCart(r, it, qty, '');
          });
          content.appendChild(row);
        }
      }

      header.addEventListener('click', () => {
        const isActive = header.classList.contains('active');
        const allHeaders = document.querySelectorAll('.accordion-header');
        const allContents = document.querySelectorAll('.accordion-content');
        
        // Close all others
        allHeaders.forEach(h => h.classList.remove('active'));
        allContents.forEach(c => c.classList.remove('active'));
        
        // Toggle current
        if (!isActive) {
          header.classList.add('active');
          content.classList.add('active');
          header.setAttribute('aria-expanded', 'true');
        } else {
          header.setAttribute('aria-expanded', 'false');
        }
      });

      accordion.appendChild(header);
      accordion.appendChild(content);
      restListEl.appendChild(accordion);
    }
  }

  // Search input handler
  const searchInput = document.getElementById('searchInput');
  searchInput.addEventListener('input', (e) => {
    filterRestaurantsAndItems(e.target.value);
  });

  function addToCart(r, it, qty, note){
    const cart = readCart();
    const other = cart.find(l => Number(l.restaurant_id) !== Number(r.rtr_id));
    if (cart.length && other) { showToast('Cart locked to another restaurant. Clear cart to switch.'); return; }
    const existing = cart.find(l => l.restaurant_id===r.rtr_id && l.item.itm_id===it.itm_id && (l.notes||'')===(note||''));
    if (existing) existing.qty = (existing.qty||1) + qty; else cart.push({ restaurant_id: r.rtr_id, restaurant_name: r.name, item: { itm_id: it.itm_id, name: it.name, unit_price: ((it.price_cents||0)/100).toFixed(2) }, qty, notes: note||'' });
    writeCart(cart);
    showToast('Added to cart');
    renderCart();
  }

  // ---------- Totals / Place order ----------
  function computeGroupTotals(lines, deliveryType='delivery', tipDollar=0) {
    const subtotal = round2(lines.reduce((acc, l) => acc + (Number(l.qty||1) * Number(l.item.unit_price||0)), 0));
    const tax = round2(subtotal * 0.0725);
    const delivery_fee = deliveryType === 'delivery' ? 3.99 : 0.00;
    const service_fee  = 1.49;
    const tip = round2(Number(tipDollar||0));
    const total = round2(subtotal + tax + delivery_fee + service_fee + tip);
    return { subtotal, tax, delivery_fee, service_fee, tip, total };
  }
  window.computeGroupTotals = computeGroupTotals;

  async function placeGroupOrder(rtrId, lines, deliveryType, tipDollar) {
    const payload = {
      restaurant_id: Number(rtrId),
      items: lines.map(l => ({ itm_id: Number(l.item.itm_id), qty: Number(l.qty||1), notes: l.notes || '' })),
      delivery_type: deliveryType,
      tip: Number(tipDollar||0),
      eta_minutes: 40,
      date: new Date().toISOString().slice(0,10),
      meal: 3
    };
    try {
      const res = await fetch(`{{ url_for('order') }}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('Order failed');
      const data = await res.json();
      showToast('Order placed!');
      const cart = readCart().filter(l => Number(l.restaurant_id) !== Number(rtrId));
      writeCart(cart);
      window.location.href = "{{ url_for('profile') }}";
    } catch (e) {
      console.error(e);
      showToast('Could not place order');
    }
  }

  // ---------- Render cart ----------
  const cartGroupsWrap = document.getElementById('cartGroups');
  const cartEmptyMsg = document.getElementById('cartEmptyMsg');
  function renderCart(){
    const cart = readCart();
    cartEmptyMsg.style.display = cart.length ? 'none' : 'block';
    cartGroupsWrap.innerHTML = '';
    if (!cart.length) return;

    const groups = new Map();
    for (const l of cart) { if (!groups.has(l.restaurant_id)) groups.set(l.restaurant_id, []); groups.get(l.restaurant_id).push(l); }

    groups.forEach((lines, rtrId) => {
      const title = lines[0]?.restaurant_name || `Restaurant #${rtrId}`;
      const groupEl = document.createElement('div');
      groupEl.className = 'order-card';
      groupEl.style.marginTop = '12px';

      let deliveryType = 'delivery';
      let tipDollar = 0;

      function updateSummary(){
        const t = computeGroupTotals(lines, deliveryType, tipDollar);
        sumEl.innerHTML = `
          <div><strong>Subtotal:</strong> $${toMoney(t.subtotal)}</div>
          <div><strong>Tax (7.25%):</strong> $${toMoney(t.tax)}</div>
          <div><strong>Delivery fee:</strong> $${toMoney(t.delivery_fee)} &nbsp; <span class="meta">(${deliveryType})</span></div>
          <div><strong>Service fee:</strong> $${toMoney(t.service_fee)}</div>
          <div><strong>Tip:</strong> $${toMoney(t.tip)}</div>
          <div style="margin-top:6px;font-size:1.05rem;"><strong>Total:</strong> $${toMoney(t.total)}</div>
        `;
      }

      const head = document.createElement('div');
      head.className = 'inline'; head.style.justifyContent = 'space-between';
      const rInfo = RESTS.find(x => Number(x.rtr_id) === Number(rtrId));
      const addrLine = formatAddress(rInfo);
      head.innerHTML = `
        <div>
          <div style="font-weight:800;">${title}</div>
          ${addrLine ? `<div class=\"meta\" style=\"margin-top:2px;\">${addrLine}</div>` : ''}
        </div>
        <div class="inline">
          <label class="meta" for="deliver-${rtrId}">Type:</label>
          <select id="deliver-${rtrId}" class="cart-select"><option value="delivery">Delivery</option><option value="pickup">Pickup</option></select>
          <label class="meta" for="tip-${rtrId}">Tip $</label>
          <input id="tip-${rtrId}" type="number" min="0" step="0.25" value="0.00" class="cart-input" style="width:90px;">
        </div>
      `;

      const table = document.createElement('div');
      for (let i = 0; i < lines.length; i++) {
        const l = lines[i];
        const row = document.createElement('div');
        row.className = 'inline';
        row.style.justifyContent = 'space-between';
        row.style.padding = '6px 0';
        row.style.borderBottom = '1px solid var(--border, #232638)';
        const left = document.createElement('div');
        left.innerHTML = `<div><strong>${l.item.name}</strong> &nbsp; <span class=\"meta\">($${toMoney(l.item.unit_price)})</span></div>${l.notes ? `<div class=\"meta\" style=\"font-size:.9rem;\">Note: ${l.notes}</div>` : ''}`;
        const right = document.createElement('div');
        right.className = 'inline';
        right.innerHTML = `<input type=\"number\" min=\"1\" step=\"1\" value=\"${l.qty||1}\" class=\"cart-input\" style=\"width:80px\" aria-label=\"Quantity\"><div style=\"width:90px; text-align:right;\">$${toMoney((l.qty||1)*Number(l.item.unit_price||0))}</div><button class=\"btn secondary\" type=\"button\" aria-label=\"Remove\">Remove</button>`;
        const qtyInput = right.querySelector('input');
        qtyInput.addEventListener('input', () => {
          const val = Math.max(1, Number(qtyInput.value||1));
          l.qty = val; writeCart(readCart()); right.querySelector('div').textContent = '$' + toMoney(val * Number(l.item.unit_price||0)); updateSummary();
        });
        right.querySelector('button').addEventListener('click', () => {
          if (!confirm('Remove this item?')) return;
          const full = readCart();
          const idx = full.indexOf(l);
          const idx2 = idx >= 0 ? idx : full.findIndex(x => x.restaurant_id===l.restaurant_id && x.item.itm_id===l.item.itm_id && (x.notes||'')===(l.notes||''));
          if (idx2 >= 0) full.splice(idx2,1);
          writeCart(full);
          renderCart();
        });
        row.appendChild(left); row.appendChild(right); table.appendChild(row);
      }

      const sumEl = document.createElement('div');
      sumEl.style.marginTop = '10px';
      const footer = document.createElement('div'); footer.className = 'inline'; footer.style.marginTop = '10px';
      const orderBtn = document.createElement('a'); orderBtn.className = 'btn'; orderBtn.textContent = 'Place Order'; orderBtn.href = '#';
      orderBtn.addEventListener('click', (e)=>{ e.preventDefault(); if (!lines.length) { showToast('No items to order'); return; } placeGroupOrder(rtrId, lines, deliveryType, tipDollar); });
      footer.appendChild(orderBtn);

      groupEl.appendChild(head);
      groupEl.appendChild(table);
      groupEl.appendChild(sumEl);
      groupEl.appendChild(footer);
      head.querySelector(`#deliver-${rtrId}`).addEventListener('change', (ev)=>{ deliveryType = ev.target.value === 'pickup' ? 'pickup' : 'delivery'; updateSummary(); });
      head.querySelector(`#tip-${rtrId}`).addEventListener('input', (ev)=>{ const v = Number(ev.target.value || 0); tipDollar = v >= 0 ? v : 0; updateSummary(); });

      updateSummary();
      cartGroupsWrap.appendChild(groupEl);
    });
  }

  document.getElementById('clearCartBtn').addEventListener('click', () => { if (!confirm('Clear your entire cart?')) return; writeCart([]); renderCart(); });

  // Init
  renderRestaurants();
  renderCart();
</script>

</body>
</html>
