name: Docs

on:
  push:
    branches: ["main"]                # deploy on main
    paths:
      - "proj2/**"
      - "scripts/**"
      - "pdoc.toml"
      - ".github/workflows/docs.yml"
  pull_request:
    branches: ["main"]                # build on PRs targeting main
    paths:
      - "proj2/**"
      - "scripts/**"
      - "pdoc.toml"
      - ".github/workflows/docs.yml"
  workflow_dispatch:                  # allow manual run from Actions tab

permissions:
  contents: write

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r proj2/requirements.txt
          pip install pdoc markdown

      - name: Build API docs (pdoc) + convert Markdown pages
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          rm -rf proj2/site
          pdoc proj2 --no-show-source --template-dir proj2/pdoc_templates -o proj2/site
          python scripts/build_docs.py
          touch proj2/site/.nojekyll

      # On PRs / manual runs, attach the site as an artifact so you can preview it
      - name: Upload docs artifact (PR/Manual)
        if: github.event_name != 'push' || github.ref != 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: proj2/site

      # Only publish when pushing to main
      - name: Publish to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: proj2/site
          publish_branch: gh-pages
